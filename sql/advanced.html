
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Advanced Usage &#8212; OpenDP SmartNoise SQL</title>
  <script>
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=9b1a4fa89bdd0e95b23b" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=9b1a4fa89bdd0e95b23b" rel="stylesheet">

  
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/6.1.2/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=9b1a4fa89bdd0e95b23b">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'advanced';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Metadata" href="metadata.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="docsearch:language" content="None">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">

  
  <input type="checkbox" class="sidebar-toggle" name="__primary" id="__primary">
  <label class="overlay overlay-primary" for="__primary"></label>

  
  <input type="checkbox" class="sidebar-toggle" name="__secondary" id="__secondary">
  <label class="overlay overlay-secondary" for="__secondary"></label>

  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
      
<form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div>

  
  <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
      <span class="fas fa-bars"></span>
  </label>
  <div id="navbar-start">
    
    
   


<a class="navbar-brand logo" href="http://docs.smartnoise.org">

  
  
  
  
  
  
  

  
    <img src="_static/smartnoise-logo.svg" class="logo__image only-light" alt="Logo image">
    <img src="_static/smartnoise-logo.svg" class="logo__image only-dark" alt="Logo image">
  
  
</a>
    
  </div>

  
  <div class="col-lg-9 navbar-header-items">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                <li class="nav-item">
                    <a class="nav-link" href="api/index.html">
                        SQL API Reference
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="metadata.html">
                        Metadata
                    </a>
                </li>
                

                <li class="nav-item current active">
                    <a class="nav-link" href="#">
                        Advanced Usage
                    </a>
                </li>
                
    </ul>
</nav>
      </div>
      
    </div>

    <div id="navbar-end">
      <div class="navbar-end-item navbar-end__search-button-container">
        
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search">
  <i class="fas fa-search"></i>
</button>
      </div>
      
      <div class="navbar-end-item">
        <span class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle">
    <a class="theme-switch" data-mode="light"><i class="fas fa-sun"></i></a>
    <a class="theme-switch" data-mode="dark"><i class="far fa-moon"></i></a>
    <a class="theme-switch" data-mode="auto"><i class="fas fa-adjust"></i></a>
</span>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          <a href="https://github.com/opendp/smartnoise-sdk" title="GitHub" class="nav-link" rel="noopener" target="_blank"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          <a href="https://twitter.com/opendp_org" title="Twitter" class="nav-link" rel="noopener" target="_blank"><span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          <a href="https://github.com/opendp/opendp/discussions" title="GitHub Discussions" class="nav-link" rel="noopener" target="_blank"><span><i class="far fa-comments"></i></span>
            <label class="sr-only">GitHub Discussions</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>


  
  <div class="search-button-container--mobile">
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search">
  <i class="fas fa-search"></i>
</button>
  </div>

  
  <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fas fa-outdent"></span>
  </label>
  

</div>
  </nav>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                <li class="nav-item">
                    <a class="nav-link" href="api/index.html">
                        SQL API Reference
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="metadata.html">
                        Metadata
                    </a>
                </li>
                

                <li class="nav-item current active">
                    <a class="nav-link" href="#">
                        Advanced Usage
                    </a>
                </li>
                
    </ul>
</nav>
      </div>
      
      </div>
    

    
    
    <div class="sidebar-header-items__end">
      
      <div class="navbar-end-item">
        <span class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle">
    <a class="theme-switch" data-mode="light"><i class="fas fa-sun"></i></a>
    <a class="theme-switch" data-mode="dark"><i class="far fa-moon"></i></a>
    <a class="theme-switch" data-mode="auto"><i class="fas fa-adjust"></i></a>
</span>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          <a href="https://github.com/opendp/smartnoise-sdk" title="GitHub" class="nav-link" rel="noopener" target="_blank"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          <a href="https://twitter.com/opendp_org" title="Twitter" class="nav-link" rel="noopener" target="_blank"><span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          <a href="https://github.com/opendp/opendp/discussions" title="GitHub Discussions" class="nav-link" rel="noopener" target="_blank"><span><i class="far fa-comments"></i></span>
            <label class="sr-only">GitHub Discussions</label></a>
        </li>
      </ul>
      </div>
      
    </div>
    
  </div>

  
  <div class="sidebar-start-items sidebar-primary__section">
    <div class="sidebar-start-items__item">
<form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div>
  

  
  <div class="sidebar-end-items sidebar-primary__section">
    <div class="sidebar-end-items__item">
    </div>
  </div>

      </div>
      <main class="bd-main">
        
        
        <div class="bd-content">
          <div class="bd-article-container">
            
            <div class="bd-header-article">
                
            </div>
            
            
            <article class="bd-article" role="main">
              
  <section id="advanced-usage">
<h1>Advanced Usage<a class="headerlink" href="#advanced-usage" title="Permalink to this headline">#</a></h1>
<p>This section covers some advanced usage scenarios.</p>
<section id="managing-privacy-budget">
<h2>Managing Privacy Budget<a class="headerlink" href="#managing-privacy-budget" title="Permalink to this headline">#</a></h2>
<p>The privacy parameters epsilon and delta are passed in to the private connection at instantiation time, and apply to each computed column during the life of the session.  Privacy cost accrues indefinitely as new queries are executed, with the total accumulated privacy cost being available via the <code class="docutils literal notranslate"><span class="pre">spent</span></code> property of the connection’s <code class="docutils literal notranslate"><span class="pre">odometer</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">privacy</span> <span class="o">=</span> <span class="n">Privacy</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">10e-7</span><span class="p">)</span>

<span class="n">reader</span> <span class="o">=</span> <span class="n">from_connection</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">privacy</span><span class="o">=</span><span class="n">privacy</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">odometer</span><span class="o">.</span><span class="n">spent</span><span class="p">)</span>  <span class="c1"># (0.0, 0.0)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT COUNT(*) FROM PUMS.PUMS&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">odometer</span><span class="o">.</span><span class="n">spent</span><span class="p">)</span>  <span class="c1"># approximately (0.1, 10e-7)</span>
</pre></div>
</div>
<p>The privacy cost increases with the number of columns:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">reader</span> <span class="o">=</span> <span class="n">from_connection</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">privacy</span><span class="o">=</span><span class="n">privacy</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">odometer</span><span class="o">.</span><span class="n">spent</span><span class="p">)</span>  <span class="c1"># (0.0, 0.0)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT AVG(age), AVG(income) FROM PUMS.PUMS&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">odometer</span><span class="o">.</span><span class="n">spent</span><span class="p">)</span>  <span class="c1"># approximately (0.4, 10e-6)</span>
</pre></div>
</div>
<p>The odometer is advanced immediately before the differentially private query result is returned to the caller.  If the caller wishes to estimate the privacy cost of a query without running it, <code class="docutils literal notranslate"><span class="pre">get_privacy_cost</span></code> can be used:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">reader</span> <span class="o">=</span> <span class="n">from_connection</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">privacy</span><span class="o">=</span><span class="n">privacy</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">odometer</span><span class="o">.</span><span class="n">spent</span><span class="p">)</span>  <span class="c1"># (0.0, 0.0)</span>

<span class="n">cost</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">get_privacy_cost</span><span class="p">(</span><span class="s1">&#39;SELECT AVG(age), AVG(income) FROM PUMS.PUMS&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>  <span class="c1"># approximately (0.4, 10e-6)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">odometer</span><span class="o">.</span><span class="n">spent</span><span class="p">)</span>  <span class="c1"># (0.0, 0.0)</span>
</pre></div>
</div>
<p>Note that the total privacy cost of a session accrues at a slower rate than the sum of the individual query costs obtained by <code class="docutils literal notranslate"><span class="pre">get_privacy_cost</span></code>.  The odometer accrues all invocations of mechanisms for the life of a session, and uses them to compute total spend.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">reader</span> <span class="o">=</span> <span class="n">from_connection</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">privacy</span><span class="o">=</span><span class="n">privacy</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT COUNT(*) FROM PUMS.PUMS&#39;</span>
<span class="n">epsilon_single</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">get_privacy_cost</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">epsilon_single</span><span class="p">)</span>  <span class="c1"># 0.1</span>

<span class="c1"># no queries executed yet</span>
<span class="nb">print</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">odometer</span><span class="o">.</span><span class="n">spent</span><span class="p">)</span>  <span class="c1"># (0.0, 0.0)</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">reader</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

<span class="n">epsilon_many</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">odometer</span><span class="o">.</span><span class="n">spent</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">epsilon_many</span><span class="si">}</span><span class="s1"> &lt; </span><span class="si">{</span><span class="n">epsilon_single</span> <span class="o">*</span> <span class="mi">100</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Odometers can be shared across multiple readers, allowing the analyst to track privacy budget across query workloads with mixed accuracy requirements.  Additionally, the analyst can pass in batches of queries to <code class="docutils literal notranslate"><span class="pre">get_privacy_cost</span></code> to estimate the total privacy cost of a set of queries, without actually spending the budget.  This can be useful for determining the best per-column epsilon to use when setting up a private reader:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">low_eps_queries</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;SELECT sex, COUNT(*) AS n FROM PUMS.PUMS GROUP BY sex&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SELECT COUNT(*) AS n FROM PUMS.PUMS&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SELECT sex, AVG(age) AS age FROM PUMS.PUMS GROUP BY sex&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SELECT AVG(age) AS age FROM PUMS.PUMS&#39;</span>
<span class="p">]</span>

<span class="n">queries</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;SELECT age, COUNT(*) AS n FROM PUMS.PUMS GROUP BY age&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SELECT educ, COUNT(*) AS n FROM PUMS.PUMS GROUP BY educ&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SELECT educ, AVG(age) AS age FROM PUMS.PUMS GROUP BY educ&#39;</span>
<span class="p">]</span>

<span class="n">low_eps_privacy</span> <span class="o">=</span> <span class="n">Privacy</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">low_eps_reader</span> <span class="o">=</span> <span class="n">snsql</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">pums</span><span class="p">,</span> <span class="n">privacy</span><span class="o">=</span><span class="n">low_eps_privacy</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">meta_path</span><span class="p">)</span>
<span class="n">eps</span><span class="p">,</span> <span class="n">delt</span> <span class="o">=</span> <span class="n">low_eps_reader</span><span class="o">.</span><span class="n">get_privacy_cost</span><span class="p">(</span><span class="n">low_eps_queries</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cost for low epsilon workload is </span><span class="si">{</span><span class="n">eps</span><span class="si">}</span><span class="s2"> epsilon and </span><span class="si">{</span><span class="n">delt</span><span class="si">}</span><span class="s2"> delta&quot;</span><span class="p">)</span>

<span class="n">privacy</span> <span class="o">=</span> <span class="n">Privacy</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">reader</span> <span class="o">=</span> <span class="n">snsql</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">pums</span><span class="p">,</span> <span class="n">privacy</span><span class="o">=</span><span class="n">privacy</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">meta_path</span><span class="p">)</span>
<span class="n">eps</span><span class="p">,</span> <span class="n">delt</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">get_privacy_cost</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cost for regular workload is </span><span class="si">{</span><span class="n">eps</span><span class="si">}</span><span class="s2"> epsilon and </span><span class="si">{</span><span class="n">delt</span><span class="si">}</span><span class="s2"> delta&quot;</span><span class="p">)</span>

<span class="c1"># use same odometer for both readers</span>
<span class="n">reader</span><span class="o">.</span><span class="n">odometer</span> <span class="o">=</span> <span class="n">low_eps_reader</span><span class="o">.</span><span class="n">odometer</span>

<span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">low_eps_queries</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">low_eps_reader</span><span class="o">.</span><span class="n">execute_df</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">low_eps_reader</span><span class="o">.</span><span class="n">odometer</span><span class="o">.</span><span class="n">spent</span><span class="p">)</span>

<span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">execute_df</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">odometer</span><span class="o">.</span><span class="n">spent</span><span class="p">)</span>
</pre></div>
</div>
<p>In the example above, the low-epsilon queries aggregate the entire dataset, so accuracy will be good without spending much budget.  The other queries in the workload aggregate down to a finer grain, so require more budget to achieve acceptable accuracy.  The code above shows how to measure the cost of the mixed workload.</p>
</section>
<section id="overriding-mechanisms">
<h2>Overriding Mechanisms<a class="headerlink" href="#overriding-mechanisms" title="Permalink to this headline">#</a></h2>
<p>You can override the default mechanisms used for differentially private summary statistics.  The mechanisms are specified in the <code class="docutils literal notranslate"><span class="pre">mechanisms.map</span></code> dictionary on the <code class="docutils literal notranslate"><span class="pre">Privacy</span></code> object.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">snsql</span> <span class="kn">import</span> <span class="n">Privacy</span><span class="p">,</span> <span class="n">Stat</span><span class="p">,</span> <span class="n">Mechanism</span>

<span class="n">privacy</span> <span class="o">=</span> <span class="n">Privacy</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;We default to using </span><span class="si">{</span><span class="n">privacy</span><span class="o">.</span><span class="n">mechanisms</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">Stat</span><span class="o">.</span><span class="n">count</span><span class="p">]</span><span class="si">}</span><span class="s2"> for counts.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Switching to use gaussian&quot;</span><span class="p">)</span>
<span class="n">privacy</span><span class="o">.</span><span class="n">mechanisms</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">Stat</span><span class="o">.</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mechanism</span><span class="o">.</span><span class="n">discrete_gaussian</span>
</pre></div>
</div>
<p>The list of statistics that can be mapped is in the <code class="docutils literal notranslate"><span class="pre">Stat</span></code> enumeration, and the mechanisms available are listed in the <code class="docutils literal notranslate"><span class="pre">Mechanism</span></code> enumeration.  The <code class="docutils literal notranslate"><span class="pre">AVG</span></code> sumamry statistic is computed from a sum and a count, each of which can be overriden.</p>
</section>
<section id="pre-aggregated">
<h2>pre_aggregated<a class="headerlink" href="#pre-aggregated" title="Permalink to this headline">#</a></h2>
<p>By default, <code class="docutils literal notranslate"><span class="pre">execute()</span></code> uses the underlying database engine to compute exact aggregates.
You can pass in exact aggregates from a different source, using the <code class="docutils literal notranslate"><span class="pre">pre_aggregated</span></code> parameter.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT sex, COUNT(*) AS n, AVG(age) AS age FROM PUMS.PUMS GROUP BY sex ORDER BY sex&#39;</span>

<span class="n">pre_agg</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;sum_age&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">510</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="mi">23500</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">490</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="mi">21000</span><span class="p">]</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">pre_aggregated</span><span class="o">=</span><span class="n">pre_agg</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[[</span><span class="s1">&#39;sex&#39;</span>, <span class="s1">&#39;n&#39;</span>, <span class="s1">&#39;age&#39;</span><span class="o">]</span>, <span class="o">[</span><span class="s1">&#39;0&#39;</span>, <span class="m">493</span>, <span class="m">42</span>.33581999011567<span class="o">]</span>, <span class="o">[</span><span class="s1">&#39;1&#39;</span>, <span class="m">511</span>, <span class="m">44</span>.43093430694777<span class="o">]]</span>
<span class="o">[[</span><span class="s1">&#39;sex&#39;</span>, <span class="s1">&#39;n&#39;</span>, <span class="s1">&#39;age&#39;</span><span class="o">]</span>, <span class="o">[</span><span class="s1">&#39;0&#39;</span>, <span class="m">487</span>, <span class="m">43</span>.40306305599861<span class="o">]</span>, <span class="o">[</span><span class="s1">&#39;1&#39;</span>, <span class="m">511</span>, <span class="m">45</span>.90357659295852<span class="o">]]</span>
<span class="o">[[</span><span class="s1">&#39;sex&#39;</span>, <span class="s1">&#39;n&#39;</span>, <span class="s1">&#39;age&#39;</span><span class="o">]</span>, <span class="o">[</span><span class="s1">&#39;0&#39;</span>, <span class="m">488</span>, <span class="m">43</span>.11059968286903<span class="o">]</span>, <span class="o">[</span><span class="s1">&#39;1&#39;</span>, <span class="m">506</span>, <span class="m">46</span>.21407160686184<span class="o">]]</span>
</pre></div>
</div>
<p>In this example, the query will skip the database and add noise to <code class="docutils literal notranslate"><span class="pre">pre_agg</span></code> directly.
Each run will add different noise.  You can pass in any iterable over tuples.</p>
<p>Note that the exact aggregates provide a SUM instead of an AVG.  This is because SmartNoise computes AVG
from a noisy COUNT and a noisy SUM.  The <code class="docutils literal notranslate"><span class="pre">execute()</span></code> method expects the <code class="docutils literal notranslate"><span class="pre">pre_aggregated</span></code> values
to match what would be obtained by running the query against an underlying database engine.</p>
<p>You can see which columns are expected by checking the AST of the rewritten query:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT sex, COUNT(*) AS n, AVG(age) AS age FROM PUMS.PUMS GROUP BY sex ORDER BY sex&#39;</span>

<span class="n">subquery</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">_rewrite</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="n">expressions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">expression</span><span class="p">)</span><span class="si">}</span><span class="s1"> AS </span><span class="si">{</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">subquery</span><span class="o">.</span><span class="n">select</span><span class="o">.</span><span class="n">namedExpressions</span>
<span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">expressions</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span><span class="s1">&#39;COUNT ( * )&#39;</span>, <span class="s1">&#39;sex&#39;</span>, <span class="s1">&#39;SUM ( age )&#39;</span><span class="o">]</span>
</pre></div>
</div>
<p>Here we see that the first column is <code class="docutils literal notranslate"><span class="pre">COUNT(*)</span></code>, the second is <code class="docutils literal notranslate"><span class="pre">sex</span></code> and the third is <code class="docutils literal notranslate"><span class="pre">SUM(age)</span></code></p>
</section>
<section id="postprocess">
<h2>postprocess<a class="headerlink" href="#postprocess" title="Permalink to this headline">#</a></h2>
<p>Several query operations do not affect privacy, because they happen after noise has been applied.
Examples include clamping negative counts, TOP/LIMIT, HAVING, and ORDER BY.  Computations such as AVG
are also performed on noisy values in post-processing.  Since the post-processing happens
after noise addition, caching layers may wish to extend budget by caching results
immediately before post-processing.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT sex, COUNT(*) AS n FROM PUMS.PUMS GROUP BY sex&#39;</span>
<span class="n">no_pp</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">postprocess</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">no_pp</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[[</span><span class="mf">485.4821800946391</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mf">511.22682440467884</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
</pre></div>
</div>
<p>Here we see that the counts have not been clamped to be integers, and the columns are ordered differently from the outer SELECT.  However, the counts are noisy, and <code class="docutils literal notranslate"><span class="pre">censor_dims</span></code> has been applied, so this result is suitable for caching and using in post-processing.</p>
<p>Note that the noisy counts are floats, because <code class="docutils literal notranslate"><span class="pre">censor_dims</span></code> is <code class="docutils literal notranslate"><span class="pre">True</span></code> by default.  If the metadata
had specified <code class="docutils literal notranslate"><span class="pre">censor_dims=False</span></code>, then the geometric mechanism would be used for these specific counts, and the values would be integers.</p>
<p>Here is a more complex example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT TOP 2 educ, AVG(age) AS age FROM PUMS.PUMS GROUP BY educ ORDER BY age DESC&#39;</span>

<span class="n">no_pp</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">postprocess</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">no_pp</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[[</span><span class="mf">34.429285994199816</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1679</span><span class="p">],</span> <span class="p">[</span><span class="mf">13.966503517008807</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">640</span><span class="p">],</span> <span class="p">[</span><span class="mf">39.30000608265984</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1757</span><span class="p">],</span> <span class="p">[</span><span class="mf">17.211438317953128</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">888</span><span class="p">],</span> <span class="p">[</span><span class="mf">24.727002841061243</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">845</span><span class="p">],</span> <span class="p">[</span><span class="mf">18.247455233675588</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">869</span><span class="p">],</span> <span class="p">[</span><span class="mf">28.619036170132635</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">776</span><span class="p">],</span> <span class="p">[</span><span class="mf">50.41413180280105</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2067</span><span class="p">],</span> <span class="p">[</span><span class="mf">200.23507699829014</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8954</span><span class="p">],</span> <span class="p">[</span><span class="mf">58.75871160176575</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2483</span><span class="p">],</span> <span class="p">[</span><span class="mf">165.14751392246907</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">7151</span><span class="p">],</span> <span class="p">[</span><span class="mf">75.87011805331791</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">3326</span><span class="p">],</span> <span class="p">[</span><span class="mf">178.57055363635266</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">8737</span><span class="p">],</span> <span class="p">[</span><span class="mf">52.596166495791834</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">2650</span><span class="p">],</span> <span class="p">[</span><span class="mf">23.02440993754067</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1311</span><span class="p">],</span> <span class="p">[</span><span class="mf">14.743632346849909</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">305</span><span class="p">]]</span>
</pre></div>
</div>
<p>Here we notice several things.  The counts are noisy and the <code class="docutils literal notranslate"><span class="pre">educ</span></code> values are not sorted in descending order.
The third column has a SUM instead of an AVG.  And the LIMIT is not applied.  But this rowset is differentially private, and
has everything necessary for post-processing.</p>
<p>The output when <code class="docutils literal notranslate"><span class="pre">postprocess=False</span></code> is the same as the input required for <code class="docutils literal notranslate"><span class="pre">pre_aggregated</span></code>.
This allows patterns like the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT TOP 2 educ, AVG(age) AS age FROM PUMS.PUMS GROUP BY educ ORDER BY age DESC&#39;</span>

<span class="n">no_pp</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">postprocess</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">pre_aggregated</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">no_pp</span><span class="p">))</span> <span class="c1"># postprocess=True</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[[</span><span class="s1">&#39;educ&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="mf">69.56647634418115</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="mf">63.23184623593364</span><span class="p">]]</span>
<span class="p">[[</span><span class="s1">&#39;educ&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="mf">50.32885468901986</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;16&#39;</span><span class="p">,</span> <span class="mf">49.724923251737366</span><span class="p">]]</span>
<span class="p">[[</span><span class="s1">&#39;educ&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="mf">54.17627519853133</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="mf">52.93913290533175</span><span class="p">]]</span>
</pre></div>
</div>
<p>In this example, <code class="docutils literal notranslate"><span class="pre">no_pp</span></code> holds differentially private values, so <code class="docutils literal notranslate"><span class="pre">pre_aggregated</span></code> is
not actually the exact aggregates, but instead can be thought of as a simulated version of the
exact aggregates.  The loop runs multiple releases, adding noise each time, without
affecting the privacy cost of the original query.  This can be useful in cases
where you want to estimate error ranges via simulation without querying the exact aggregates
repeatedly.  It can also be useful when caching results to avoid spending budget.  For example,
in the above, the caller could do sequential queries with different LIMIT or ORDER BY,
without spending additional budget.  Queries for SUM (not requested in the original query) could
also be answered with no additional privacy cost.</p>
<p>Note that the result of <code class="docutils literal notranslate"><span class="pre">postprocess=False</span></code> will ensure that rare dimensions are censored,
to ensure that the result is differentially private.  Passing this result back in as
<code class="docutils literal notranslate"><span class="pre">pre_aggregated</span></code> could result in additional dimensions near the threshold being
censored, because noise will be added again.  This may or may not be desirable, depending on your
application.  For example, if you are trying to estimate error ranges, you may want
to set <code class="docutils literal notranslate"><span class="pre">censor_dims=False</span></code> when generating the <code class="docutils literal notranslate"><span class="pre">postprocess=False</span></code> result, and then
set <code class="docutils literal notranslate"><span class="pre">censor_dims=True</span></code> on each of the simulated runs.</p>
</section>
</section>


            </article>
            
            
            
            <footer class="bd-footer-article">
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
  <a class='left-prev' id="prev-link" href="metadata.html" title="previous page">
      <i class="fas fa-angle-left"></i>
      <div class="prev-next-info">
          <p class="prev-next-subtitle">previous</p>
          <p class="prev-next-title">Metadata</p>
      </div>
  </a>
</div>
            </footer>
            
          </div>
          
          
          
            <div class="bd-sidebar-secondary bd-toc">
              
<div class="toc-item">
  
<div class="tocsection onthispage">
    <i class="fas fa-list"></i> On this page
</div>
<nav id="bd-toc-nav" class="page-toc">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#managing-privacy-budget">
   Managing Privacy Budget
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overriding-mechanisms">
   Overriding Mechanisms
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pre-aggregated">
   pre_aggregated
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#postprocess">
   postprocess
  </a>
 </li>
</ul>

</nav>
</div>

<div class="toc-item">
  
</div>

<div class="toc-item">
  
<div class="tocsection sourcelink">
    <a href="_sources/advanced.rst.txt">
        <i class="fas fa-file-alt"></i> Show Source
    </a>
</div>

</div>

            </div>
          
          
        </div>
        <footer class="bd-footer-content">
          <div class="bd-footer-content__inner">
            
          </div>
        </footer>
        
      </main>
    </div>
  </div>

  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=9b1a4fa89bdd0e95b23b"></script>

  <footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    
<p class="copyright">

    &copy; Copyright 2022.<br>

</p>

  </div>
  
  <div class="footer-item">
    
<p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.1.2.<br>
</p>

  </div>
  
</div>
  </footer>
  </body>
</html>